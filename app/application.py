import json, time, os, re, datetime
from urllib.parse import urlparse
from flask import Blueprint, session, g, redirect, render_template, flash, request, jsonify, url_for
from app import app, db
from . models import Subdomains,Users, Vulnerabilities
from . scanner  import Solver
from . subs import PassiveTools
from . expand import Expands
from .serialize import Serializer
from .auth import login_required
from . holds import bugs

scan =  Blueprint("scan", __name__, template_folder="templates", static_folder="static", url_prefix="/scan")


path = os.getcwd()
path =  path+"/output"

config_path = os.getcwd() + "/templates/"
@scan.route("/")
def home():
    return redirect(url_for('auth.home'))


@scan.route("/subs", methods=["POST", "GET"])
@login_required
def subfinder():
    if request.method == "POST":
        target = request.form["target"]
        parser = PassiveTools(target)
        parser.findomain(path + "/findomain.txt")
        parser.subfinder( path + "/subfinder.txt")
        parser.combine(path + "/subdomains")
        message = "Gathering subdomains, this may take a while..."
        flash(message)
        time.sleep(3)

        with open(path + "/findomain.txt", "r") as subdomains:
            for sub in subdomains:
                print(sub)
                statement = Subdomains(subdomain=sub.strip())
                db.session.add(statement)
            db.session.commit()
        subdomains = Subdomains.query.all()
        data = Serializer.serialize_list(subdomains)
        return redirect(url_for("scan.urls")), 302
    return render_template("/subs/subs.html")

@scan.route("/urls", methods=["GET", "POST"])
@login_required
def urls():
    expands_file = path + "/expands.txt"
    subs_file = path + "/findomain.txt"
    urls_file = path + "/urls.txt"
    eee = Expands(subs_file)
    eee.expander()
    cmd = "cat {} | httpx -silent -threads 200 -o {}".format(expands_file, urls_file)
    os.system(cmd)
    subs = Subdomains.query.all()
    info = Serializer.serialize_list(subs)
    #: time.sleep(30)
    #: print(info)
    with open(urls_file, "r") as rr:
        for line in rr:
            line = line.strip()
            for sub in info["data"]:
                if urlparse(line).netloc.split(":")[0] == sub["data"]["subdomain"]:
                    sub["data"]["urls"].append(line)
                    sub["data"]["ports"].append(int(urlparse(line).netloc.split(":")[-1]))
    #: print(info)
    """big problem below"""
    #: print(subs)
    for sub in subs:
        for data in info["data"]:
            if data["data"]["subdomain"] == sub.subdomain:
                #: print("adasasdaassdassd")
                #: print(sub.urls)
                #: print(data["data"]["urls"])
                sub.urls = data["data"]["urls"]
                sub.ports = data["data"]["ports"]
                sub.date_checked = datetime.datetime.today()
                db.session.commit()
                if len(data["data"]["urls"]) != 0:
                       sub.is_active = True
                else:
                       sub.is_active = False
    db.session.commit()
    data = Subdomains.query.all()
    #: print(Serializer.serialize_list(data))
    return redirect(url_for('scan.display'))


@app.route("/scanner", methods=["GET", "POST"])
def scanner():
    configs = path + "/templates/"
    urls = path + "/output/urls.txt"
    subdomains = Subdomains.query.all()
    data = Serializer.serialize_list(subdomains)
    solver = Solver(urls = urls, directory = configs)
    solver.open_urls()
    solver.load_configs()
    solver.requester()
    solver.request_regex()
    for bug in bugs:
        info = Vulnerabilities(bug=bug)
        db.session.add(info)
        db.session.commit()
    return redirect(url_for("scan.display_bugs")),302

@scan.route("/display/subs", methods=["GET", "POST", "OPTIONS"])
@login_required
def display():
    subs = Subdomains.query.all()
    info = Serializer.serialize_list(subs)
    for data in info["data"]:
        data["data"]["date_checked"] = str(data["data"]["date_checked"])
    return jsonify(info), 200


@scan.route("/display/bugs", methods=["GET", "POST", "OPTIONS"])
@login_required
def display_bugs():
    data =  Vulnerabilities.query.all()
    bugs = Serializer.serialize_list(data)
    return {"Bugs": bugs}, 200


@scan.route("/thankyou")
@login_required
def thank_you():
    message = "Thank you"
    return render_template("/thankyou.html"), 200

import json, re, datetime, os
import requests, yaml
import concurrent.futures
from urllib3.exceptions import InsecureRequestWarning

yaml.warnings({'YAMLLoadWarning': False})

class Loader(object):

    def __init__(self, urls, directory):
        self.urls = urls
        self.directory = directory

    def opener(self):
        pass

    def open_multiple_configs(self):
        self.configs = os.listdir(self.directory)
        return self.configs

    def configReader(self):
        #: config = self.config
       for self.config in  self.configs:
            with open(self.directory+self.config, "r") as confs:
                data = yaml.load(confs)
            self.method = data["requests"][0]["method"]
            self.path = data["requests"][0]["path"][0].removeprefix("{{BaseURL}}")
            self.condition = data["requests"][0]["matchers-condition"]
            #: self.status = data["requests"][0]["matchers"][-2]["status"][0]
            self.matchers = data["requests"][0]["matchers"]
            self.severity = data["info"]["severity"]
            self.method = "GET"
            print(self.path)
            print(self.path)
            for type_ in self.matchers:
                if type_["type"] == "status":
                    self.status = type_["status"][0]
                elif type_["type"] == "word" and  type_["part"] == "header":
                    self.word_h = type_["words"][0]
                elif type_["type"] == "word" and type_["part"] == "body":
                    self.word_b = type_["words"][0]
                elif type_["type"] == "regex" and type_["part"] == "header":
                    self.re_header = type_["regex"][0]
                elif type_["type"] == "regex" and type_["part"] == "body":
                    self.re_body = type_["regex"][0]
                    print(self.re_body)
                elif _type["type"] == regex and part_["part"] == "body":
                    self.re_header = type["regex"][0]
                else:
                    pass
            self.configs.remove(self.config)

    def open_urls(self):
        #: urls = self.urls
        self.lists = []
        with open(self.urls, "r") as urls:
            for url in urls:
                url = url.strip()
                url = url+self.path
                self.lists.append(url)
        #: print(*self.files)
        return self.lists

    def requester(self):
        #url = self.lists
        self.timeout = 20
        self.method = requests.options
        if self.method == "GET":
            self._method = requests.get
        elif self.method == "POST":
            self._method = requests.post
        elif self.method == "PUT":
            self._method = requests.put
        else:
            self._method =  requests.delete
        for url in self.lists:
            requests.packages.urllib3.disable_warnings()
            self.res = self._method(url, allow_redirects=True, verify=False)
            if self.res.status_code == self.status and self.word_b in self.res.content.decode() and self.word_h in str(self.res.headers):
                #: print(self.res.url)
                self.lists.remove(url)
                return {
                    "url":self.res.url,"code":self.res.status_code,"state": True,
                    "severity": self.severity,"endpoint": self.path,
                    "evidence": [{
                        "headers": self.word_h,
                        "body": self.word_b
                        }]
                }, self.requester(), self.configReader()
            else:
                #:  print(self.res.url)
                self.lists.remove(url)
                return self.requester(), self.configReader()
            """return json.dumps({
            "status":self.res.status_code,"url":self.res.url,"state":False
            })"""


loader =  Loader(config="./configs/nginx-version.yaml",urls="urls.txt")
loader.configReader()
loader.opener()
loader.requester()
